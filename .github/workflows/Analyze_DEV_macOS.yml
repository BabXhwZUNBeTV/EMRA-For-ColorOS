name: EMRA For ColorOS_DEV_macOS

on:
  workflow_dispatch:
    inputs:
      link:
        description: "ROM 链接"
        required: true
      push:
        description: "上传数据库"
        required: true
        type: choice
        options:
        - "是"
        - "否"
      devicename:
        description: "设备名"
        required: false
      osversion:
        description: "系统版本"
        required: false


jobs:
  Analyze:
    runs-on: windows-latest

    steps:
    - name: Install cygwin
      uses: egor-tensin/setup-cygwin@v4

    - name: Install scoop
      uses: MinoruSekine/setup-scoop@v4
      with:
        apps: aria2 7zip git

    - name: Install python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10' 
        
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependence
      run: |
        pip install -r requirements.txt

    - name: Download payload-dumper-go
      uses: robinraju/release-downloader@v1.10
      with:
        repository: "ssut/payload-dumper-go"
        latest: true
        extract: true
        fileName: "payload-dumper-go_*_windows_amd64.tar.gz"

    - name: Download extract.erofs
      uses: robinraju/release-downloader@v1.10
      with:
        repository: "sekaiacg/erofs-utils"
        latest: true
        extract: true
        fileName: "erofs-utils-*-Cygwin_x86_64-*.zip"

    - name: Remove file
      run: |
       del *.tar.gz
       del *.zip

    - name: Download ROM
      run: |
        python main.py -d "${{ github.event.inputs.link }}"

    - name: Unzip payload.bin
      run: |
        python main.py -p
        rm *.zip

    - name: Unzip img
      run: |
        python main.py -i
        rm payload.bin
    
    - name: Unzip file
      run: |
        python main.py -f
        rm *.img
    
    - name: Remove exclude apk
      run: |
        python main.py -a

    - name: Get version
      run: |
        python main.py -n

    - name: Update database
      run: |
        python main.py -u

    - name: Rename
      run: |
        python main.py -m

    - name: Upload json
      uses: actions/upload-artifact@v4
      with:
        name: Update_json
        path: |
          app_version.json
          app_code.json
    
    - name: Upload update_apk
      uses: actions/upload-artifact@v4
      with:
        name: Update_apk
        path: |
          update_apk
          update_name_apk

    - name: Update database
      run: |
        git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
        git config --global user.name "${GITHUB_ACTOR}"
        git add app_version.json app_code.json
        if [ "${{ github.event.inputs.push }}" = "是" ]; then
            git commit -m "Upload Database ${{ github.event.inputs.devicename }} ${{ github.event.inputs.osversion }}"
            git push origin main
          elif [ "${{ github.event.inputs.push }}" = "否" ]; then
            exit 0
          else
            exit 0
          fi
        
